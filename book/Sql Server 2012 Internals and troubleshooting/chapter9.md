### Chapter 9: Troubleshoothing Methology and Practice

=> 목표
* 문제해결 방법론
* 성공적인 문제해결을 위한 10단계
* 팀들과 복잡한 문제를 해결하기위한 접근방식

SQL 문제 해결을 위해서는 다음의 3단계를 따른다.
1. 문제를 정의한다.
2. 데이터 수집, 분석 작업을 반복한다.
3. 해결방법의 유효성을 검사하고 이행한다.

문제에 접근하는 방법
* 성공적인 문제 해결을 위한 10단계( 가장 핵심은 문제의 근본적 원인을 파악하는 것이다.)
	* 문제의 정의
	* 문제가 끼치는 영향의 범위 명확화하기
	* 명확한 자원 참여시키기
	* 잠재적인 원인 확인하기
	* 각 팀들간의 작업에 대한 협업 및 계획세우기
	* 의사소통 계획 및 리뷰하기
	* 근본 원인 확인하기
	* 해결책 결정하기
	* 테스트하고, 수행하기
	* 리뷰하기
	
-> 생각보다 간단한 것 같지만 바로 해결책을 정하지 않는다. 급할수록 돌아가야한다는 느낌이다. 근본원인을 확인하는 것은 7번 째에 등장한다. 문제를 정의 하는 것이 우선이라는 것이 내게는 좀 생소했다. 복잡한 것 같지만 계속 반복하다보면 문제 발생 시 좀 더 침착하게 대응할 수 있을 것 같다.

행동과 태도
* 문제가 발생 했을 때 어떤 태도를 어떤 행동을 취해야 하는지 알아본다.
	* 평정심 유지 (말로는 정말 쉬운 평정심 유지...)
	* 문제는 절대 무작위로 일어나지 않는다는 인식
	* 편견 피하기
	* 해결책 찾는 것 피하기 ( 위에서도 말했지만 원인을 찾는 것이 가장 우선이다.)
	* 미리 생각해보기 ( 결론은 예방을 잘 하자는 것이다.)
	
성공의 기준
* 성공의 기준을 결정하는 것은 굉장히 어려운 일이다. 문제 해결에 있어서 어디서 멈춰야 하는지 고민해야 하는 부분이기 때문이다.

이해 관계자들과 협업
* 이해관계자들의 범위는 다양하다.
* 매니저들은 비지니스의 영향범위를 결정하는 것이 가장 중요하다.
	* 시스템에 얼마나 큰 영향을 미치는가?
	* 얼마나 많은 유저들이 영향을 받는가?
	* 손해를 보는 비용은 어느 정도 인가?
	* 눈에 보이는 문제는 무엇인가?
	* 외부 고객들도 영향을 받는가?
	* 얼마나 심각한 문제가 존재하는가?
	
서비스 범위의 결정
* RTO (Recovery time objective)
* RPO (Recovery point objective)
* 비슷하지만 다른 개념임. ex) RPO는 15 분, RTO는 4hors 장애복구는 4시간 데이터 유실은 장애시점의 15분 전

외부의 도움 받기
* 외부의 도움이 항상 필요하지는 않다. 하지만 외부의 도움을 받아야 하는 상황이 왔을 때 어떠한 형태로 처리해야 하는지도 알아둬야 한다.
* 도움을 받기로 결정했을 때 다음 사항을 고려해야한다.
	* 사용환경 개요 준비(네트워크 구성도, 어플리케이션 구조)
	* 문제의 상태 및 재현 단계
	* 해결의 성공기준
	* 핵심 이해 관계자
	* 문제와 해결을 위해 이미 취해진 조치
	* 윈도우 시스템, 어플리케이션, SQL server 이벤트 로그
	* 프로파일 결과(가능하다면)
	* SQLDiag 결과 
	
문제의 정의
* 문제를 이해하고, 어플리케이션의 환경을 조사하는 것이 문제해결을 빨리 하는 길이다. 복잡한 문제의 경우 명확한 이해가 뒷받침 되지 않으면 결코 원인을 찾아낼 수 없다. 설정, 패턴, 문제의 특징을 파악하는 것이 문제를 해결하는 데 포인트이다. 
* 또한 문제를 통해 배운 것들을 정리해두는 것도 중요하다. 

문제 정의 가이드라인
* end-to-end 어플리케이션 환경을 도식화 해둔다.
* 주요 하드웨어 스펙을 정리해둔다.
* 관련된 로그를 모은다.
	* Windows and system event logs
	* SQL Server error logs
	* Dump files
	* Application logs
* 실패난 상황의 시간 및 이벤트 흐름 도식화
* 정상적일 때와 아닐 때의 변화 이벤트 로그 등으로 확인가능
* 문제의 재현을 위한 필수 단계에 대한 이해
* 성공 범위에 대한 기준 동의 구하기
* 로그 문법에 대한 이해 및 패턴 파악, 어플리케이션들의 타임존 체크
* 해당 서비스의 비즈니스 흐름 이해하기 (다른 서비스와 다른 특징을 갖는 점이 있는지 파악)
* 문제가 발생하지 않을 때의 상태 확인하기.

-> 관련되 보이지 않은 작은 것도 그냥 넘어가는 것은 옳지 않다. 어떠한 변화, 윈도우 및 sql 서버 패치, 새로운 정책 및 권한, 설정 옵션, 스키마 변경 등을 가볍게 넘어가면 안된다.

문제의 분리
* 문제가 발생했을 때 그 문제의 원인을 DB에서 볼수 있는 명확한 근거가 있는가? 많은 문제가 다양한 원인을 가지고 있다. 그래서 문제를 명확히 하기 위해서는 발생한 문제를 분해하는 것이 중요하다. 문제 원인에 대한 주요 범주는 아래와 같다.
	* 연결문제 - 프로토콜 문제, 어플리케이션, 유저, 클라이언트 워크스테이션, 서브넷과 같은 연결에서 문제가 발생하는지? 단지 Double Hops, Direct Connect에 문제가 있는지? 로컬연결은 되지만 원격연결은 안되는지? Name연결의 이슈인지, 라우팅 체크가 되었는지? DAC(Dedicated Administrator Connection)으로 연결되었는지? 등 다양한 연결 문제를 고려할 수 있다.
	* 성능문제 - 문제가 발생하는 지점을 결정해야 한다. 클라이언트인지, 미들웨어인지, SQL 서버의 문제인지, 네트워크의 문제인지 확인해야 한다. 예를 들어 10초의 성능이 걸리는 쿼리가 있을 때 원격과 로컬에서 각 실행해보는 것이다.
	* 하드웨어 병목 - 디스크, CPU, 네트워크, 메모리의 문제인지 확인하는 것, 다양한 툴들로 가장 성능이 좋지 않은 쿼리를 확인하여 조사한다.
	* SQL Server 문제 - SQL Server는 한정된 자원을 가지고 있다. locks, latches, worker threads, shared resources (예 temp db)등의 자원들을 DMV를 통해 조사한다.
	* Compilation issues - 쿼리 플랜, 통계의 유효성, 비효율 적인 index, plan cache 등을 확인한다.

자원 병목현상 
* 자원 문제 해결은 병목현상을 수반한다. 이미 존재했던 것일 수 있고, 문제발생하는 동안 데이터 수집을 통해 분석할 수 있다. 이러한 병목을 하나 해결할 때 다른 병목현상을 찾아서 해결하는 작업을 반복해야한다.
* Memory - 메모리 문제는 물리적인 메모리를 늘릴것인지, 메모리의 설정 옵션을 변경할 것인지 체크해 볼 필요가 있다. 또한 32bit의 sql server를 사용하고 있다면 64bit 버전으로 변경하는 것도 고려해보아야한다. 또한 메모리를 많이 사용하는 쿼리를 확인하여 쿼리 플랜을 확인할 필요가 있다. 
* CPU - CPU 문제는 자주 또는 가끔 발생하는 것이다. 자주 발생하는 CPU문제는 주로 CPU 수의 문제이다. 쿼리가 대기하는 시간이 길다면 병목 문제인지 확인이 필요하다. CPU 갯수를 늘릴것인지 속도를 높일것인지 병렬처리가 의도된 것인지 아닌지 확인이 필요하다. Top 10의 나쁜 성능을 가진 쿼리를 튜닝하는 것이 필요하다.(hash join, sort, computed column)
* Storage I/O - 메모리와 CPU보다 느리다. 그래서 고려할 사항은 Average Disk Sec/Read와 Average Disk Sec/Write를 확인 해야 한다. 보통 OLTP 시스템은 20milliseconds보다 낮아야 좋은 성능이라고 할 수 있다. STATISTICS IO 캐쉬를 확인한다. Storage 성능은 아래 사항들을 고려한다. 
	* Raid level
	* Disk Type(enterprise flash disk, SCSI)
	* Dedicated or shared disk arrays
	* Connectivity(InfiniBand, Fibre Channel, iSCSI)
	* HBA cache and queue settings
	* HBA load balancing policy(active, active vs. active; or passive)
	* NTFS cluster size
	* Layout and isolation of data, index, log, and tempdb files
	* Storage cache and controllers policy
* Network - 언뜻 보면 SQL Server의 문제라고 인식할 수 있다. 쿼리 결과가 보내지지 않거나 받는 속도가 지연될경우 SQL server가 느린것 처럼 보일 수 있다. 이 경우 SQL Server의 상호작용을 기능적으로 조사해보아야한다. SQL profiler와 같은 툴로 실행되는 프로시저, 함수, 쿼리들을 실행해 보아야한다. 
